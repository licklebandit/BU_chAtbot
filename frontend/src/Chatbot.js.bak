import React, { useState, useEffect } from "react";
import axios from "axios";

// Static styles object should be defined outside the component 
// to prevent re-creation on every render, improving performance.
const styles = {
    container: { display: "flex", height: "100vh", background: "#f4f8ff", position: "relative", overflow: "hidden", fontFamily: 'Arial, sans-serif' },
    menuButton: { 
        position: "absolute", top: 10, left: 10, background: "#0a59b4ff", color: "white", border: "none", 
        borderRadius: "50%", width: "40px", height: "40px", lineHeight: "40px", textAlign: "center", 
        cursor: "pointer", zIndex: 20, fontSize: "20px", boxShadow: "0 2px 5px rgba(0,0,0,0.2)" 
    },
    topBar: { display: "flex", justifyContent: "flex-end", alignItems: "center", marginBottom: "10px" },
    authButtons: { display: "flex", gap: "10px" },
    loginBtn: { 
        padding: "8px 16px", backgroundColor: "white", color: "#1257a5ff", border: "1px solid #1257a5ff", 
        borderRadius: "20px", textDecoration: "none", fontWeight: "bold", fontSize: "14px", transition: "all 0.2s ease", cursor: "pointer" 
    },
    signupBtn: { 
        padding: "8px 16px", backgroundColor: "#1257a5ff", color: "white", border: "none", borderRadius: "20px", 
        textDecoration: "none", fontWeight: "bold", fontSize: "14px", transition: "background-color 0.2s ease", cursor: "pointer" 
    },
    logoutBtn: { 
        padding: "8px 16px", backgroundColor: "#d32f2f", color: "white", border: "none", borderRadius: "20px", 
        fontWeight: "bold", cursor: "pointer", fontSize: "14px", transition: "background-color 0.2s ease" 
    },
    sidebar: { 
        position: "fixed", top: 0, width: "280px", height: "100%", background: "#f8fafaff", borderRight: "1px solid #83d7f8ff", 
        padding: "15px", display: "flex", flexDirection: "column", overflowY: "auto", transition: "left 0.3s ease", zIndex: 10 
    },
    botHeader: { display: "flex", alignItems: "center", gap: "10px", marginBottom: "20px", paddingBottom: "10px", borderBottom: "1px solid #eee" },
    avatar: { width: "50px", height: "50px", borderRadius: "50%" },
    newChatBtn: { 
        background: "#0a59b4ff", color: "white", border: "none", borderRadius: "10px", padding: "10px", 
        cursor: "pointer", marginBottom: "15px", fontWeight: "bold", boxShadow: "0 2px 4px rgba(0,0,0,0.1)" 
    },
    section: { marginBottom: "15px" },
    sectionTitle: { 
        fontSize: "14px", fontWeight: "bold", marginBottom: "8px", color: "#131392ff", 
        borderBottom: "1px solid #f0f0f0", paddingBottom: "4px" 
    },
    link: { fontSize: "13px", color: "#252424ff", margin: "6px 0", cursor: "pointer", padding: "4px 8px", borderRadius: "4px", transition: "background-color 0.1s" },
    chatList: { maxHeight: "180px", overflowY: "auto", paddingRight: "5px" },
    chatItem: { borderBottom: "1px solid #eee", padding: "6px 0", cursor: "pointer", transition: "background-color 0.2s", borderRadius: "4px", paddingLeft: "8px", '&:hover': { backgroundColor: '#f0f0f0' } },
    chatTitle: { fontSize: "13px", fontWeight: "600", margin: 0 },
    chatTime: { fontSize: "10px", color: "#777", margin: 0, marginTop: "2px" },
    main: { flex: 1, display: "flex", flexDirection: "column", padding: "20px", height: "100vh", overflow: "hidden", transition: "margin-left 0.3s ease", 
        marginLeft: 0 
    },
    chatWindow: { flex: 1, overflowY: "auto", marginBottom: "10px", padding: "15px", background: "white", borderRadius: "12px", boxShadow: "0 4px 12px rgba(0, 77, 140, 0.1)" },
    message: { display: "inline-block", padding: "10px 14px", borderRadius: "20px", maxWidth: "75%", lineHeight: "1.4" },
    inputRow: { display: "flex", gap: "10px", alignItems: "center" },
    input: { flex: 1, padding: "12px", borderRadius: "25px", border: "1px solid #1131bdff", fontSize: "16px" },
    button: { background: "#1257a5ff", color: "white", border: "none", borderRadius: "25px", padding: "12px 20px", cursor: "pointer", fontWeight: "bold", transition: "background-color 0.2s" },
};


function Chatbot() {
Â  const [messages, setMessages] = useState([]);
Â  const [input, setInput] = useState("");
Â  const [loading, setLoading] = useState(false);
Â  const [freeCount, setFreeCount] = useState(0);
Â  const [chats, setChats] = useState([]);
Â  const [isLoggedIn, setIsLoggedIn] = useState(false);
Â  const [sidebarOpen, setSidebarOpen] = useState(window.innerWidth >= 769);

Â  // 1. Resize Listener for Sidebar
Â  useEffect(() => {
Â  Â  const handleResize = () => {
Â  Â  Â  setSidebarOpen(window.innerWidth >= 769);
Â  Â  };
Â  Â  window.addEventListener('resize', handleResize);
Â  Â  return () => window.removeEventListener('resize', handleResize);
Â  }, []);

Â  // 2. Initial Setup
Â  useEffect(() => {
Â  Â  const token = localStorage.getItem("token");
Â  Â  setIsLoggedIn(!!token);
Â  Â  if (token) fetchChats();

Â  Â  setMessages([{ id: crypto.randomUUID(), role: "assistant", text: "ğŸ“ Welcome! How can I help you today?" }]);
Â  }, []);

Â  const fetchChats = async () => {
Â  Â  const token = localStorage.getItem("token");
Â  Â  if (!token) return;
Â  Â  try {
Â  Â  Â  const res = await axios.get("https://bu-chatbot.onrender.com/chat/history", {
Â  Â  Â  Â  headers: { Authorization: `Bearer ${token}` },
Â  Â  Â  });
Â  Â  Â  setChats(res.data ? res.data.slice(-5).reverse() : []);
Â  Â  } catch (err) {
Â  Â  Â  console.error("Error fetching chats:", err);
Â  Â  }
Â  };

Â  const loadChat = (chatMessages) => {
Â  Â  // Ensure loaded messages have a unique ID for React keys
Â  Â  const messagesWithIds = (chatMessages || []).map(msg => ({ 
        ...msg, 
        id: msg.id || crypto.randomUUID() 
    }));
Â  Â  setMessages(messagesWithIds);
Â  Â  if (window.innerWidth < 769) setSidebarOpen(false);
Â  };

Â  const resetChat = () => {
Â  Â  setMessages([{ id: crypto.randomUUID(), role: "assistant", text: "New session started. How can I help you today?" }]);
Â  Â  setFreeCount(0);
Â  Â  if (window.innerWidth < 769) setSidebarOpen(false);
Â  };

Â  const sendMessage = async () => {
Â  Â  if (!input.trim()) return;
Â  Â  if (!isLoggedIn && freeCount >= 3) {
Â  Â  Â  setMessages((prev) => [
Â  Â  Â  Â  ...prev,
Â  Â  Â  Â  { id: crypto.randomUUID(), role: "assistant", text: "ğŸ”’ Youâ€™ve reached your free question limit. Please login or sign up to continue." },
Â  Â  Â  ]);
Â  Â  Â  return;
Â  Â  }

Â  Â  // Generate unique ID for the user message
Â  Â  const userMsg = { id: crypto.randomUUID(), role: "user", text: input }; 
Â  Â  setMessages((prev) => [...prev, userMsg]);
Â  Â  setInput("");
Â  Â  setLoading(true);

Â  Â  try {
Â  Â  Â  const token = localStorage.getItem("token");
Â  Â  Â  
Â  Â  Â  const res = await axios.post(
Â  Â  Â  Â  "https://bu-chatbot.onrender.com/chat",
Â  Â  Â  Â  { q: userMsg.text },
Â  Â  Â  Â  { headers: token ? { Authorization: `Bearer ${token}` } : {} }
Â  Â  Â  );

Â  Â  Â  // Generate unique ID for the bot message
Â  Â  Â  const botMsg = { id: crypto.randomUUID(), role: "assistant", text: res.data.answer }; 
Â  Â  Â  setMessages((prev) => [...prev, botMsg]);
Â  Â  Â  
Â  Â  Â  if (!isLoggedIn) setFreeCount((c) => c + 1);
Â  Â  Â  if (isLoggedIn) fetchChats();
Â  Â  } catch (err) {
Â  Â  Â  console.error(err);
Â  Â  Â  setMessages((prev) => [
Â  Â  Â  Â  ...prev,
Â  Â  Â  Â  { id: crypto.randomUUID(), role: "assistant", text: "âš ï¸ Unable to process your message. Please try again." },
Â  Â  Â  ]);
Â  Â  } finally {
Â  Â  Â  setLoading(false);
Â  Â  }
Â  };

Â  return (
Â  Â  <>
Â  Â  Â  <style>{`
Â  Â  Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  Â  .sidebar { left: -300px; transition: left 0.3s ease; }
Â  Â  Â  Â  Â  .sidebar.open { left: 0; box-shadow: 2px 0 5px rgba(0,0,0,0.4); }
Â  Â  Â  Â  Â  .menu-btn { display: block; }
Â  Â  Â  Â  Â  .main { margin-left: 0 !important; padding-top: 50px; }
Â  Â  Â  Â  Â  .chat-history { max-height: 180px; }
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (min-width: 769px) {
Â  Â  Â  Â  Â  .menu-btn { display: none; }
Â  Â  Â  Â  Â  .main-shift { margin-left: 300px !important; }
Â  Â  Â  Â  }
        /* Improved link hover style */
        .sidebar .link:hover {
            background-color: #e6f7ff;
        }
Â  Â  Â  `}</style>

Â  Â  Â  <div style={styles.container}>
Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  className="menu-btn"
Â  Â  Â  Â  Â  style={styles.menuButton}
Â  Â  Â  Â  Â  onClick={() => setSidebarOpen(!sidebarOpen)}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  {sidebarOpen ? "âœ–" : "â˜°"}
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <div className={`sidebar ${sidebarOpen ? "open" : ""}`} style={styles.sidebar}>
Â  Â  Â  Â  Â  <div style={styles.botHeader}>
Â  Â  Â  Â  Â  Â  <img src="/bot.png" alt="BU Bot" style={styles.avatar} />
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h2 style={{ margin: 0, color: "#16559dff" }}>BU Chatbot</h2>
Â  Â  Â  Â  Â  Â  Â  <p style={{ fontSize: "13px", margin: 0 }}>Your AI Campus Assistant</p>
Â  Â  Â  Â  Â  Â  Â  <p style={{ fontSize: "12px", margin: "4px 0", color: "#4caf50" }}>ğŸŸ¢ Online</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <button style={styles.newChatBtn} onClick={resetChat}>
Â  Â  Â  Â  Â  Â  + New Chat
Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  <div style={styles.section}>
Â  Â  Â  Â  Â  Â  <h4 style={styles.sectionTitle}>Select Topic</h4>
Â  Â  Â  Â  Â  Â  {["Admissions","Registration","Academics","Financial Aid","Student Life","Campus Tour","Nearby Hostels","Cafeteria"].map((topic) => (
Â  Â  Â  Â  Â  Â  Â  <p key={topic} className="link" style={styles.link} onClick={() => setInput(topic)}>{topic}</p>
Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  {isLoggedIn && chats.length > 0 && (
Â  Â  Â  Â  Â  Â  <div style={styles.section}>
Â  Â  Â  Â  Â  Â  Â  <h4 style={styles.sectionTitle}>ğŸ’¬ Recent Chats ({chats.length})</h4>
Â  Â  Â  Â  Â  Â  Â  <div className='chat-history' style={styles.chatList}>
Â  Â  Â  Â  Â  Â  Â  Â  {chats.map((c, i) => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div key={c.id || c._id || i} style={styles.chatItem} onClick={() => loadChat(c.messages)}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style={styles.chatTitle}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {c.messages?.find(m => m.role === 'user')?.text?.slice(0, 30) || "Conversation"}...
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style={styles.chatTime}>{new Date(c.updatedAt).toLocaleDateString()}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  )}

Â  Â  Â  Â  Â  <div style={styles.section}>
Â  Â  Â  Â  Â  Â  <h4 style={styles.sectionTitle}>University Resources</h4>
Â  Â  Â  Â  Â  Â  {["Student Portal","Academic Calendar","Work Program","Hospital","Emergency Contacts"].map((r) => (
Â  Â  Â  Â  Â  Â  Â  <p key={r} className="link" style={styles.link}>{r}</p>
Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div className={`main ${sidebarOpen && window.innerWidth >= 769 ? "main-shift" : ""}`} style={styles.main}>
Â  Â  Â  Â  Â  <div style={styles.topBar}>
Â  Â  Â  Â  Â  Â  {!isLoggedIn ? (
Â  Â  Â  Â  Â  Â  Â  <div style={styles.authButtons}>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="/login" style={styles.loginBtn}>Login</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="/signup" style={styles.signupBtn}>Sign Up</a>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  <div style={styles.authButtons}>
Â  Â  Â  Â  Â  Â  Â  Â  <button style={styles.logoutBtn} onClick={() => { localStorage.removeItem("token"); setIsLoggedIn(false); }}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Logout
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style={styles.chatWindow}>
Â  Â  Â  Â  Â  Â  {messages.length === 0 && <p style={{ color: "#044163ff" }}>What do you like to know about Bugema University!</p>}
Â  Â  Â  Â  Â  Â  {messages.map((msg) => (
Â  Â  Â  Â  Â  Â  Â  {/* Use unique 'msg.id' for key */}
Â  Â  Â  Â  Â  Â  Â  <div key={msg.id} style={{ textAlign: msg.role === "user" ? "right" : "left", marginBottom: 10 }}>
Â  Â  Â  Â  Â  Â  Â  Â  <span style={{
Â  Â  Â  Â  Â  Â  Â  Â  Â  ...styles.message,
Â  Â  Â  Â  Â  Â  Â  Â  Â  background: msg.role === "user" ? "#0078ff" : "#e8f0ff",
Â  Â  Â  Â  Â  Â  Â  Â  Â  color: msg.role === "user" ? "white" : "black",
Â  Â  Â  Â  Â  Â  Â  Â  }}>{msg.text}</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  {loading && <p style={{ textAlign: 'left', margin: '10px 0' }}>Typing...</p>}
Â  Â  Â  Â  Â  Â  <div style={{ float:"left", clear: "both" }} />
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style={styles.inputRow}>
Â  Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  Â  style={styles.input}
Â  Â  Â  Â  Â  Â  Â  placeholder="Ask about admissions, courses, or campus life..."
Â  Â  Â  Â  Â  Â  Â  value={input}
Â  Â  Â  Â  Â  Â  Â  onChange={(e) => setInput(e.target.value)}
Â  Â  Â  Â  Â  Â  Â  onKeyDown={(e) => e.key === "Enter" && sendMessage()}
Â  Â  Â  Â  Â  Â  Â  disabled={loading}
Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  <button style={styles.button} onClick={sendMessage} disabled={loading || !input.trim()}>
Â  Â  Â  Â  Â  Â  Â  Send
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <p style={{ fontSize: "11px", color: "#777", textAlign: "center", marginTop: "5px" }}>
Â  Â  Â  Â  Â  Â  {!isLoggedIn ? `Free questions remaining: ${3 - freeCount}` : "Logged in. Unlimited access."}
Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </>
Â  );
}

export default Chatbot;